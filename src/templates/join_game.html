<!-- join_game.html -->
<!DOCTYPE html>
<html lang="en">

{% extends 'base.html' %}

{% block title %}Join Game{% endblock %}

{% block styles %}
<style>
    .team-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 90vh; /* Adjust the height as needed */
    }

    .team-card {
        border: 1px solid #ccc;
        width: 30%;
        min-width: 300px;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .player-list {
        list-style: none;
        padding: 0;
    }

    .player-item {
        margin-bottom: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
        padding: 10px;
        border-radius: 5px;
        user-select: text;
    }

    .player-item.selected {
        background-color: #e6f7ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="team-container">
    <form id="join-form">

        <div class="team-card">
            <h2 class="red">Red Team</h2>
            <ul class="player-list" id="red-team-players">
                {% for player in redTeamPlayers %}
                <div class="player-item">
                    {{ player['username'] }}
                    <input class="player-name" type="hidden" name="player-name" value="{{ player['username'] }}">
                </div>
                {% endfor %}
            </ul>
        </div>

        <div class="team-card">
            <h2 class="black">Black Team</h2>
            <ul class="player-list" id="black-team-players">
                {% for player in blackTeamPlayers %}
                <div class="player-item">
                    {{ player['username'] }}
                    <input class="player-name" type="hidden" name="player-name" value="{{ player['username'] }}">
                </div>
                {% endfor %}
            </ul>
        </div>

        <button type="button" onclick="startGame()">Start Game</button>
    </form>
</div>

<script src="/static/socket.io.min.js"></script>
<script>
    const socket = io.connect('http://' + document.domain + ':' + location.port + '/');
    socket.on('connect', function () {
        console.log('Socket connected');
    });

    // Add a single click event listener to the parent container
    document.getElementById('red-team-players').addEventListener('click', function (event) {
        const target = event.target;

        // Check if the clicked element has the 'player-item' class
        if (target.classList.contains('player-item')) {
            togglePlayerSelection(event, target, 'RED');
        }
    });

    document.getElementById('black-team-players').addEventListener('click', function (event) {
        const target = event.target;

        // Check if the clicked element has the 'player-item' class
        if (target.classList.contains('player-item')) {
            togglePlayerSelection(event, target, 'BLACK');
        }
    });

    function togglePlayerSelection(event, element, team) {
        const playerName = element.innerText.trim(); // Trim to remove leading/trailing whitespaces

        element.classList.toggle('selected');
        const isChecked = element.classList.contains('selected');
        console.log('toggling selected class')
        console.log(isChecked)


        // Emit an event to update the server with the player list changes
        socket.emit('update_player', { team: team, playerName: playerName, isChecked: isChecked });
    }

    socket.on('update_players', function (data) {
        // Update the player lists on the client side
        const redTeamList = document.getElementById('red-team-players');
        const blackTeamList = document.getElementById('black-team-players');

        console.log(data);

        // Assuming data.redTeamPlayers and data.blackTeamPlayers are arrays of player names
        updatePlayerListUI(redTeamList, data.redTeamPlayers, data.allowedRedTeamPlayers, 'red');

        updatePlayerListUI(blackTeamList, data.blackTeamPlayers, data.allowedRedTeamPlayers, 'black');
    });

    function updatePlayerListUI(playerList, teamPlayers, allowedPlayers, team) {
        playerList.innerHTML = '';

        // Populate the list with updated player names
        teamPlayers.forEach(playerName => {
            createPlayerListItem(playerList, team, playerName, true);
        });

        allowedPlayers.forEach(playerName => {
            createPlayerListItem(playerList, team, playerName, false);
        });
    }

    function createPlayerListItem(playerList, team, playerName, checked) {

        const listItem = document.createElement('li');
        listItem.classList.add('player-item');

        if (checked === true) {
            console.log(`re adding selected class for ${playerName}`)
            listItem.classList.add('selected');
        } else{
            console.log(`removing selected class for ${playerName}`)
            listItem.classList.remove('selected');
        }

        const label = document.createElement('label');
        label.classList.add('player-item');
        label.htmlFor = team + '-' + playerName;
        label.innerText = playerName;
        listItem.appendChild(label);
        playerList.appendChild(listItem);
    }

    function limitSelection(checkbox) {
        const checkboxes = document.querySelectorAll('input[name="' + checkbox.name + '"]:checked');

        if (checkboxes.length > 2) {
            checkbox.checked = false;
        }
    }

    function startGame() {
        // Initialize the arrays
        const redTeamPlayers = [];
        const blackTeamPlayers = [];

        // Get selected players for each team
        const blackCheckboxes = document.querySelectorAll('input[name="black-players"]:checked');
        const redCheckboxes = document.querySelectorAll('input[name="red-players"]:checked');

        Array.from(blackCheckboxes).forEach(checkbox => blackTeamPlayers.push(checkbox.value));
        Array.from(redCheckboxes).forEach(checkbox => redTeamPlayers.push(checkbox.value));

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/start_game', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    // Redirect to the game page on successful join
                    window.location.href = '/game_page';
                } else {
                    alert('Failed to start the game. Please try again.');
                }
            }
        };

        const data = JSON.stringify({ redTeamPlayers: redTeamPlayers, blackTeamPlayers: blackTeamPlayers });
        xhr.send(data);
    }
</script>

{% endblock %}

</html>
